#!/bin/sh

SOURCE_BUNDLE_NAME=GZDoom.app
BUNDLE_EXECUTABLE_PATH=Contents/MacOS/GZDoom

DEPLOY_IMAGE_DIR=.deploy_image
DEPLOY_SDL_DIR=${DEPLOY_IMAGE_DIR}/GZDoom_SDL.app
DEPLOY_COCOA_DIR=${DEPLOY_IMAGE_DIR}/GZDoom_Cocoa.app

cd "`dirname \"$0\"`/.."

echo "Preparing directories..."
rm -r ${DEPLOY_IMAGE_DIR} 2>/dev/null
mkdir ${DEPLOY_IMAGE_DIR}
ln -s /Applications ${DEPLOY_IMAGE_DIR}/Applications

echo "Copying game..."
cp -R build/Release_SDL/${SOURCE_BUNDLE_NAME}/ ${DEPLOY_SDL_DIR}
cp -R build/Release_Cocoa/${SOURCE_BUNDLE_NAME}/ ${DEPLOY_COCOA_DIR}

echo "Stripping executables..."
strip ${DEPLOY_SDL_DIR}/${BUNDLE_EXECUTABLE_PATH}
strip ${DEPLOY_COCOA_DIR}/${BUNDLE_EXECUTABLE_PATH}

echo "Removing duplicate files..."
misc/trimtrees.pl ${DEPLOY_SDL_DIR} ${DEPLOY_COCOA_DIR} > /dev/null

echo "Copying documentation..."
mkdir ${DEPLOY_IMAGE_DIR}/Documentation
cp -R docs/ ${DEPLOY_IMAGE_DIR}/Documentation
cp ReadMe.rtf ${DEPLOY_IMAGE_DIR}

echo "Building image..."
hdiutil create -srcfolder ${DEPLOY_IMAGE_DIR} -volname GZDoom -format UDBZ ${DEPLOY_IMAGE_DIR}/GZDoom.dmg
